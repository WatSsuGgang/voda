# 포팅 매뉴얼

## 개발환경
* 도커 이미지 및 컨테이너를 활용

### Infra
* Nginx: [1.25.4](https://hub.docker.com/_/nginx)
* Jenkins: [2.448](https://hub.docker.com/r/jenkins/jenkins)
* AWS: AWS EC2 xlarge
    * CPU: 4vCPUs
    * RAM: 16GB
    * SSD: 320GB SSD

### Backend
* JDK: [eclipse-temurin:17-jdk-alpine](https://hub.docker.com/_/eclipse-temurin)
* mysql: [8.3.0](https://hub.docker.com/_/mysql)
* redis: [7.2.4](https://hub.docker.com/_/redis)
* Spring boot: 3.2.3
    * Gradle
    * Spring Data JPA

### 외부 서비스
* [NAVER AI CLOVA](https://www.ncloud.com/product/aiService)
    * CLOVA Voice - Premium
    * CLOVA Speech Recognition
* [Claude - Sonnet](https://www.anthropic.com/claude)
* [Karlo](https://developers.kakao.com/product/karlo)

### Frontend
* JavaScript: es6
* Node: [Node:20.10.0-alpine](https://hub.docker.com/_/node)
* React: 18.2.0
* Vite: 5.1.4
    * Vite PWA: 0.19.2
* Zustand: 4.5.2

## 환경변수

### Backend
* application.yml
```yaml
server:
  servlet:
    context-path: /api/v1
spring:
  config:
    import:
      - application-oauth.yml
      - application-datasource.yml
      - application-secret.yml
```
* application-datasource.yml
```yaml
spring:
  datasource:
    url: jdbc:mysql://{서버 URL}:{mysql 포트 번호}/${DATABASE_NAME}
    username: root
    password: ${ROOT_PASSWORD}
    driver-class-name: com.mysql.cj.jdbc.Driver
  jpa:
    database-platform: org.hibernate.dialect.MySQLDialect
    show-sql: true #(JPA 쿼리문 확인 가능)
    hibernate:
      ddl-auto: update #(테이블 있으면 Drop 후 Create)
    properties:
      hibernate:
        format_sql: true #(hibernate가 동작하며 발생하는 sql의 가독성을 높여준다.)
  data:
    redis:
      host: {서버 URL}
      port: {redist 포트 번호}
      password: {redis 비밀번호}
cloud:
  aws:
    s3:
      bucket: {S3 bucket 이름}
    stack.auto: false
    region.static: {S3 리전}
    credentials:
      accessKey: {S3 accessKey}
      secretKey: {S3 secertKey}
```
* application-oauth.yml
```yaml
spring:
  security:
    oauth2:
      client:
        registration:
          google:
            client-id: ${GOOGLE.CLIENT_ID}
            client-secret: ${GOOGLE.CLIENT_SECRET}
            redirect-uri: "{서버 URL}/api/v1/login/oauth2/code/google"
            scope:
              - email
          naver:
            client-id: ${NAVER.CLIENT_ID}
            client-secret: ${NAVER.CLIENT_SECRET}
            client-authentication-method: client_secret_post
            authorization-grant-type: authorization_code
            # TODO "{baseUrl}/{action}/oauth2/code/{registrationId}" 로 수정
            redirect-uri: "{서버 URL}/api/v1/login/oauth2/code/naver"
            scope:
              - email
            client-name: Naver
          kakao:
            client-id: ${KAKAO.CLIENT_ID}
            client-secret: ${KAKAO.CLIENT_SECRET}
            client-authentication-method: client_secret_post
            authorization-grant-type: authorization_code
            scope:
              - account_email
            redirect-uri: "{서버 URL}/api/v1/login/oauth2/code/kakao"
            client-name: Kakao

        provider:
          naver:
            authorization_uri: https://nid.naver.com/oauth2.0/authorize
            token_uri: https://nid.naver.com/oauth2.0/token
            user-info-uri: https://openapi.naver.com/v1/nid/me
            user-info-authentication-method: header
            user_name_attribute: response # Naver 응답 값 resultCode, message, response 중 response 지정
          kakao:
            authorization_uri: https://kauth.kakao.com/oauth/authorize
            token_uri: https://kauth.kakao.com/oauth/token
            user-info-uri: https://kapi.kakao.com/v2/user/me
            user-info-authentication-method: header
            user_name_attribute: id # Kakao 응답 값 id, connected_at, properties, kakao_account 중 id 지정
```
* application-secret.yml
    * 각 서비스에 대한 인증키 발급은 [인증키 발급 매뉴얼](./인증키%20발급%20매뉴얼.md)을 참고해주세요.
```yaml
KAKAO:
  CLIENT_ID: {REST API Key}
  CLIENT_SECRET: {Client Secret}
NAVER:
  CLIENT_ID: {Client ID}
  CLIENT_SECRET: {Client Secret}
GOOGLE:
  CLIENT_ID: {Client ID}
  CLIENT_SECRET: {Client Secret}
Claude:
  x-api-key: {ANTHROPIC_API_KEY}
  anthropic-version: {anthropic-version}
spring:
  jwt:
    secret: {jwt secret key}
Clova:
  X-NCP-APIGW-API-KEY-ID: {Client ID}
  X-NCP-APIGW-API-KEY: {Client Secret}
Karlo:
  client-id: {REST API Key}
FRONT_URL: {서버 URL}

DATABASE_NAME: {mysql database 이름}
ROOT_PASSWORD: {mysql root 비밀번호}
```

### Frontend
* env
    * 각 서비스에 대한 인증키 발급은 [인증키 발급 매뉴얼](./인증키%20발급%20매뉴얼.md)을 참고해주세요.
```text
VITE_EMOJI_URL = https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis
VITE_PUBLIC_URL = {서버 URL}
VITE_API_URL = {서버 URL}/api/v1
VITE_GOOGLE_CLIENT_ID = 963584923627-ku7141o1dm4nq5ugll3ih2tl41fu79g4.apps.googleusercontent.com
VITE_KAKAO_CLIENT_ID = 2e256ffa440486b66b3c21c8724fe7d2
VITE_NAVER_CLIENT_ID = wic9nTjqZY5Ok1jwb5Jv
```

## EC2 환경 세팅

### 방화벽 설정
```sh
sudo ufw enable
sudo ufw allow 80 
sudo ufw allow 443

sudo ufw disable # ufw 비활성화
```

### 스왑 메모리 공간 설정
```sh
sudo -s
# 현재 메모리 확인
free
# 램 크기마다 bs와 count 단위가 달라짐
# 현재 램이 16G이고 32G로 잡기 위해 1G씩 32번 count하는 것으로 설정
# 스왑 메모리는 사용중인 램의 2배 이상으로 잡는 것이 좋다고 함
# 생각보다 오래걸리므로 기다리기
sudo dd if=/dev/zero of=/mnt/swapfile bs=1G count=32

sudo mkswap /mnt/swapfile

sudo swapon /mnt/swapfile

free -h
```

### 도커 설치
* [공식 문서](https://docs.docker.com/engine/install/ubuntu/)를 참고해주세요.

